name: entity-collector-ci

on:
  push:
    paths:
      - "entity-collector/**"
      - ".github/workflows/collector-dev.yml"
  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    env:
      OCIR_HOST: <region>.ocir.io
      OCIR_REPO: <region>.ocir.io/${{ secrets.OCI_TENANCY_NS_DEV }}/entity-collector

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Build dependencies first
        run: |
          mvn -q -DskipTests clean install -f commons/pom.xml
          mvn -q -DskipTests clean install -f commons-jooq/pom.xml
          mvn -q -DskipTests clean install -f commons-security/pom.xml

      - name: Build entity-collector jar
        working-directory: entity-collector
        run: mvn -q -DskipTests clean package

      - name: Copy built jar for Dockerfile
        run: |
          mkdir -p target
          cp entity-collector/target/entity-collector-1.0.0.jar target/

      # - name: Login to OCIR
      #   run: echo "${{ secrets.OCI_AUTH_TOKEN_DEV }}" | docker login $OCIR_HOST -u "${{ secrets.OCI_USERNAME_DEV }}" --password-stdin

      # - name: Build & push Docker image
      #   run: |
      #     docker build -t $OCIR_REPO:${{ github.sha }} \
      #                  -t $OCIR_REPO:latest \
      #                  -f entity-collector/Dockerfile .
      #     docker push $OCIR_REPO:${{ github.sha }}
      #     docker push $OCIR_REPO:latest

      # - name: Install OpenVPN
      #   run: sudo apt-get install -y openvpn

      # - name: Connect to VPN
      #   run: |
      #     echo "${{ secrets.VPN_CONFIG }}" | base64 --decode > vpn.ovpn
      #     sudo openvpn --config vpn.ovpn \
      #       --auth-user-pass <(printf "%s\n%s" "${{ secrets.VPN_USER }}" "${{ secrets.VPN_PASS }}") \
      #       --daemon
      #     sleep 10

      # - name: Setup SSH key
      #   run: |
      #     mkdir -p ~/.ssh
      #     echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
      #     chmod 600 ~/.ssh/id_rsa

      # - name: Restart service on DEV server
      #   run: |
      #     ssh -o StrictHostKeyChecking=no opc@${{ secrets.DEV_SERVER_IP }} \
      #       "bash /home/opc/dev/keepup.sh dev-entity-collector-server $OCIR_REPO:${{ github.sha }}"
